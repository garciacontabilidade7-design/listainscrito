<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista de Inscritos</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:0; }
    h1 { text-align:center; margin:20px 0; }
    .status { text-align:center; margin:6px 0; color:#333; }
    .contador { display:block; margin:10px auto; text-align:center; font-size:18px; padding:10px 20px; background:#4CAF50; color:#fff; font-weight:bold; border-radius:8px; width:fit-content; }
    .busca-container { margin:10px; text-align:center; }
    .busca-container input { padding:10px; width:100%; max-width:400px; border:1px solid #ddd; border-radius:5px; }
    .tabela-container { overflow-x:auto; margin:10px; border:1px solid #ddd; border-radius:5px; max-height:70vh; overflow-y:auto; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; min-width:900px; font-size:14px; }
    thead th { position:sticky; top:0; background:#4CAF50; color:#fff; padding:10px; text-align:left; }
    tbody tr:nth-child(even) { background:#E2F0D9; }
    tbody tr:nth-child(odd) { background:#FFFFFF; }
    tbody td { padding:8px; vertical-align:top; border-bottom:1px solid #eee; }
    tbody tr:hover { background:#c8e6c9; cursor:pointer; }
    a.whatsapp-link { color:#25D366; font-weight:bold; text-decoration:none; }
    a.whatsapp-link:hover { text-decoration:underline; }
    .btn-pdf, .btn-csv { display:inline-block; margin:10px 6px; padding:10px 20px; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s; }
    .btn-pdf { background:#2196F3; }
    .btn-pdf:hover { background:#0b7dda; }
    .btn-csv { background:#FF9800; }
    .btn-csv:hover { background:#e68900; }
    @media(max-width:768px){ .busca-container input{ max-width:100%; } }
    @media(max-width:500px){
      thead { display:none; }
      table, tbody, tr, td { display:block; width:100%; }
      td { border:none; padding:8px 5px; border-bottom:1px solid #eee; }
    }
  </style>
</head>
<body>
  <h1>Lista de Inscritos</h1>
  <div class="status" id="status">Carregando inscritos...</div>
  <div class="contador" id="contador">Total de inscritos: 0</div>

  <div class="busca-container">
    <input type="text" id="busca" placeholder="Buscar por nome, email, telefone...">
  </div>

  <div style="text-align:center">
    <button class="btn-pdf" id="btnPDF">Gerar PDF</button>
    <button class="btn-csv" id="btnCSV">Gerar CSV</button>
  </div>

  <div class="tabela-container" id="tabela-container">
    <table id="tabela" aria-live="polite">
      <thead><tr id="cabecalho"></tr></thead>
      <tbody id="corpo"></tbody>
    </table>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    const SHEET_URL =
      "https://opensheet.elk.sh/1eL2o3TdQUKkx_qrw6iyAg7pI2FpVivu67AJrz2eOo90/Respostas%20ao%20formul%C3%A1rio%201";

    let headers = [];
    let dados = [];

    async function carregarInscritos(){
      const statusEl = document.getElementById("status");
      try {
        statusEl.textContent = "Buscando dados da planilha...";
        const resp = await fetch(SHEET_URL);
        if (!resp.ok) throw new Error("Falha no carregamento: " + resp.status);

        const json = await resp.json();
        if (!json || json.length === 0) throw new Error("Planilha vazia ou sem acesso Ã  aba.");

        headers = Object.keys(json[0]);
        dados = json;

        montarCabecalho();
        montarTabela(dados);
        atualizarContagem();
        statusEl.textContent = "Dados carregados com sucesso!";
      } catch(e) {
        console.error(e);
        statusEl.textContent = "Erro ao carregar dados.";
      }
    }

    function montarCabecalho(){
      const headEl = document.getElementById("cabecalho");
      headEl.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headEl.appendChild(th);
      });
    }

    function isPhoneHeader(h){
      return /whats|telefone|celular|fone|contato/i.test(h);
    }

    function montarTabela(linhas){
      const corpo = document.getElementById("corpo");
      corpo.innerHTML = "";

      linhas.forEach(linha => {
        const tr = document.createElement("tr");

        headers.forEach(h => {
          const td = document.createElement("td");
          const val = (linha[h] || "").toString();

          if (isPhoneHeader(h)) {
            const num = val.replace(/\D/g,"");
            if (num)
              td.innerHTML = `<a class="whatsapp-link" target="_blank" href="https://wa.me/55${num}">${val}</a>`;
            else td.textContent = val;
          } else {
            td.textContent = val;
          }

          tr.appendChild(td);
        });

        corpo.appendChild(tr);
      });
    }

    function atualizarContagem(){
      const visiveis = document.querySelectorAll("#corpo tr:not([style*='display: none'])").length;
      document.getElementById("contador").textContent =
        "Total de inscritos: " + visiveis;
    }

    document.getElementById("busca").addEventListener("input", function(){
      const filtro = this.value.toLowerCase();
      const linhas = document.querySelectorAll("#corpo tr");
      linhas.forEach(tr => {
        const txt = tr.innerText.toLowerCase();
        tr.style.display = txt.includes(filtro) ? "" : "none";
      });
      atualizarContagem();
    });

    document.getElementById("btnPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'pt', 'a4');

      const cab = headers;
      const linhas = Array.from(document.querySelectorAll("#corpo tr"))
        .filter(tr => tr.style.display !== "none")
        .map(tr => Array.from(tr.cells).map(td => td.textContent));

      doc.setFontSize(14);
      doc.text("Lista de Inscritos", doc.internal.pageSize.getWidth()/2, 30, { align: "center" });

      doc.autoTable({ head: [cab], body: linhas, startY: 50 });
      doc.save("inscritos.pdf");
    });

    document.getElementById("btnCSV").addEventListener("click", () => {
      const linhas = Array.from(document.querySelectorAll("#corpo tr"))
        .filter(tr => tr.style.display !== "none")
        .map(tr => Array.from(tr.cells).map(td => td.textContent.replace(/;/g, ",")));

      const csv = [headers.join(";"), ...linhas.map(l => l.join(";"))].join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "inscritos.csv";
      link.click();
      URL.revokeObjectURL(url);
    });

    carregarInscritos();
  </script>
</body>
</html>
