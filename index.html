<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Inscritos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .counter {
      text-align: center;
      font-size: 1.3rem;
      margin-top: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border-radius: 8px;
      display: inline-block;
      min-width: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #ddd;
      word-break: break-word;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .small { font-size: 0.9rem; color: #555; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Lista de Inscritos</h1>
  <div class="counter" id="counter">Total de inscritos: 0</div>
  <input type="text" id="search" placeholder="Buscar por nome..." />
  <table id="inscritos">
    <thead>
      <tr>
        <th>Nome Completo</th>
        <th>Data de Nascimento</th>
        <th>CPF</th>
        <th>WhatsApp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="small">Observação: o parser agora trata corretamente células com vírgulas; o WhatsApp é extraído da coluna 10 (J).</div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/1bBf-BGm2yYvLFL9krgcr5a5296As-oppljsw7pCeGqA/export?format=csv&gid=469018608";
    const searchInput = document.getElementById("search");
    const counter = document.getElementById("counter");
    const tbody = document.querySelector("#inscritos tbody");

    function formatPhone(num) {
      if (!num) return "";
      num = num.replace(/^0+/, "");
      const only = num.replace(/\D/g, '');
      if (only.length === 11) {
        return '(' + only.slice(0,2) + ') ' + only.slice(2,7) + '-' + only.slice(7);
      } else if (only.length === 10) {
        return '(' + only.slice(0,2) + ') ' + only.slice(2,6) + '-' + only.slice(6);
      } else {
        return num;
      }
    }

    async function fetchData() {
      const response = await fetch(CSV_URL);
      if (!response.ok) throw new Error('Erro ao buscar CSV: ' + response.status);
      const text = await response.text();
      const parsed = Papa.parse(text, { skipEmptyLines: true }).data;

      // Ignora linha de cabeçalho "Nome Completo" e similares
      let startIndex = 0;
      for (let i = 0; i < parsed.length; i++) {
        const r = parsed[i];
        if (r && r[1]) {
          const nomeTest = r[1].toString().trim().toLowerCase();
          if (
            nomeTest !== "nome completo" &&
            nomeTest.split(/\s+/).length >= 2
          ) {
            startIndex = i;
            break;
          }
        }
      }

      const rows = parsed.slice(startIndex);

      let data = rows.map(row => {
        const nome = row[1] ? row[1].toString().trim() : "";
        const nascimento = row[2] ? row[2].toString().trim() : "";
        const cpf = row[3] ? row[3].toString().trim() : "";
        let whatsappRaw = row[9] ? row[9].toString() : "";
        let whatsappDigits = whatsappRaw.replace(/\D/g, '');
        if (!whatsappDigits) {
          for (let k = 10; k < row.length; k++) {
            const alt = (row[k] || '').toString().replace(/\D/g, '');
            if (alt) { whatsappDigits = alt; break; }
          }
        }
        return { nome, nascimento, cpf, whatsapp: whatsappDigits };
      });

      data = data.filter(item => {
        if (!item.nome) return false;
        const wc = item.nome.trim().split(/\s+/).filter(Boolean).length;
        return wc >= 2 && item.nome.toLowerCase() !== "nome completo";
      });

      return data;
    }

    function renderTable(data) {
      tbody.innerHTML = "";
      data.forEach(item => {
        const tr = document.createElement("tr");

        const tdNome = document.createElement("td");
        tdNome.textContent = item.nome;

        const tdData = document.createElement("td");
        tdData.textContent = item.nascimento;

        const tdCpf = document.createElement("td");
        tdCpf.textContent = item.cpf;

        const tdWhatsapp = document.createElement("td");
        tdWhatsapp.textContent = item.whatsapp ? formatPhone(item.whatsapp) : "";

        tr.appendChild(tdNome);
        tr.appendChild(tdData);
        tr.appendChild(tdCpf);
        tr.appendChild(tdWhatsapp);
        tbody.appendChild(tr);
      });

      counter.textContent = `Total de inscritos: ${data.length}`;
    }

    searchInput.addEventListener("input", async (event) => {
      const searchTerm = event.target.value.toLowerCase();
      const data = await fetchData();
      const filtered = data.filter(item => item.nome.toLowerCase().includes(searchTerm));
      renderTable(filtered);
    });

    fetchData().then(data => renderTable(data)).catch(err => {
      console.error(err);
      alert('Erro ao carregar dados: ' + err.message);
    });
  </script>
</body>
</html>
