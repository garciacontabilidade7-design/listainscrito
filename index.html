<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista de Inscritos</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background:#f4f4f4; 
      margin:0; 
      padding:0; 
    }
    h1 { text-align:center; margin:20px 0; }
    .contador { 
      display:block; margin:20px auto; text-align:center; font-size:18px; 
      padding:10px 20px; background:#4CAF50; color:#fff; font-weight:bold; 
      border-radius:8px; width:fit-content; 
    }
    .busca-container { margin:10px; text-align:center; }
    .busca-container input { 
      padding:10px; width:100%; max-width:400px; border:1px solid #ddd; border-radius:5px; 
    }
    .tabela-container { 
      overflow-x:auto; margin:10px; border:1px solid #ddd; border-radius:5px; 
      max-height:70vh; overflow-y:auto; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    table { width:100%; border-collapse:collapse; min-width:900px; font-size:14px; }
    thead th { 
      position:sticky; top:0; background:#4CAF50; color:#fff; padding:10px; text-align:left; 
    }
    tbody tr:nth-child(even) { background:#E2F0D9; }
    tbody tr:nth-child(odd) { background:#FFFFFF; }
    tbody td { padding:8px; vertical-align:top; border-bottom:1px solid #eee; }
    tbody tr:hover { background:#c8e6c9; cursor:pointer; }
    a.whatsapp-link { color:#25D366; font-weight:bold; text-decoration:none; }
    a.whatsapp-link:hover { text-decoration:underline; }
    .btn-pdf, .btn-csv { 
      display:block; margin:10px auto; padding:10px 20px; 
      color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s;
    }
    .btn-pdf { background:#2196F3; }
    .btn-pdf:hover { background:#0b7dda; }
    .btn-csv { background:#FF9800; }
    .btn-csv:hover { background:#e68900; }

    @media(max-width:768px){
      .busca-container input{ max-width:100%; }
    }
    @media(max-width:500px){
      thead { display:none; }
      table, tbody, tr, td { display:block; width:100%; }
      td { border:none; padding:8px 5px; border-bottom:1px solid #eee; }
    }
  </style>
</head>
<body>
  <h1>Lista de Inscritos</h1>

  <div class="contador" id="contador">Total de inscritos: 0</div>

  <div class="busca-container">
    <input type="text" id="busca" placeholder="Buscar por nome...">
  </div>

  <button class="btn-pdf" id="btnPDF">Gerar PDF</button>
  <button class="btn-csv" id="btnCSV">Gerar Seguro</button>

  <div class="tabela-container" id="tabela-container">
    <table id="tabela">
      <thead><tr id="cabecalho"></tr></thead>
      <tbody id="corpo"></tbody>
    </table>
  </div>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

 <script>
const API = "https://script.google.com/macros/s/AKfycbwOkzGBF4w7XXzC4Wi48sl3SfK82lXPrLiZix2-IxWAfwQjRt-RuUe_jAPRJEK95aWe/exec";

let headers = [];
let dados = [];
let pagos = [];

function formatarDataISO(valor) {
  if (!valor) return "";
  const d = new Date(valor);
  if (isNaN(d)) return valor;
  return `${String(d.getDate()).padStart(2, "0")}/${String(d.getMonth() + 1).padStart(2, "0")}/${d.getFullYear()}`;
}

async function carregarPagos() {
  const resp = await fetch(API + "?acao=pagamentos");
  pagos = await resp.json();
}

async function carregarInscritos() {
  const resp = await fetch(API + "?acao=inscritos");
  const json = await resp.json();

  if (!json || json.length === 0) return;

  const colunas = Object.keys(json[0]);

  headers = [
    colunas[1],
    colunas[2],
    colunas[19],
    colunas[3],
    colunas[4],
    colunas[5],
    colunas[6],
    colunas[7],
    colunas[15],
    colunas[9],
    colunas[10],
    colunas[11],
    colunas[12],
    "PAGAMENTO"
  ];

  dados = json;

  montarCabecalho();
  montarTabela(dados);
  atualizarContagem();
}

function montarCabecalho() {
  const headEl = document.getElementById("cabecalho");
  headEl.innerHTML = "";
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    headEl.appendChild(th);
  });
}

function montarTabela(linhas) {
  const corpo = document.getElementById("corpo");
  corpo.innerHTML = "";

  linhas.forEach(linha => {
    const tr = document.createElement("tr");

    headers.forEach(h => {
      const td = document.createElement("td");

      if (h === "PAGAMENTO") {
        let cpf = linha["CPF"] || linha["cpf"] || "";
        cpf = cpf.toString().replace(/\D/g, "");

        if (pagos.includes(cpf)) {
          td.innerHTML = `<span style="color:green;font-weight:bold;">PAGO âœ”</span>`;
        } else {
          td.innerHTML = `<button onclick="marcarPago('${cpf}')">Marcar como pago</button>`;
        }

        tr.appendChild(td);
        return;
      }

      let val = (linha[h] ?? "").toString().trim();

      if (h.toLowerCase().includes("data")) {
        val = formatarDataISO(val);
      }

      if (h.toLowerCase().includes("whats")) {
        const digits = val.replace(/\D/g, "");
        if (digits) {
          const withDDI = digits.startsWith("55") ? digits : "55" + digits;
          td.innerHTML = `<a target="_blank" class="whatsapp-link" href="https://wa.me/${withDDI}">${digits}</a>`;
        } else {
          td.textContent = "";
        }
      } else {
        td.textContent = val;
      }

      tr.appendChild(td);
    });

    corpo.appendChild(tr);
  });
}

async function marcarPago(cpf) {
  if (!cpf) return;

  await fetch(API + "?acao=pagar&cpf=" + cpf, { method: "POST" });

  await carregarPagos();
  montarTabela(dados);
}

function atualizarContagem() {
  const linhas = document.querySelectorAll("#corpo tr");
  document.getElementById("contador").textContent =
    "Total de inscritos: " + linhas.length;
}

window.onload = async () => {
  await carregarPagos();
  await carregarInscritos();
};
</script>
</body>
</html>
